---
title: "session2"
author: "Kevin Wang and Garth Tarr"
date: "05/11/2019"
output:
  html_document:
    css: style.css
---


# Learning outcomes of this session

+ `left_join` data
+ Making basic plots using `ggplot2`: boxplots, histograms and scatter plots
+ Joining two datasets together (`left_join`)
+ `pivot_longer` and `pivot_wider` to reshape data for visualisation purposes



# Loading packages

```{r}
library(tidyverse)
```


# Loading cleaned sample data

Let's begin today by loading the csv file that we created on Monday. 

```{r}
session1_data = read_csv(file = "data/clean_sample_data.csv")
```

# Reading in gene expression data (top 10 rows)

We will also read in another data which we haven't dealt with yesterday. This is a gene expression data that was saved as a `txt` file. The delimiter is a tab, or `\t`. We will only read in the first 6 rows for convenience. 

```{r}
raw_ge_data = read_delim(file = "data/GSE43251_NanoString_non-normalized.txt", delim = "\t", n_max = 6)
# raw_ge_data = read_tsv(file = "data/GSE43251_NanoString_non-normalized.txt", n_max = 5)

clean_ge_data = raw_ge_data %>% 
  dplyr::select(-1)

clean_ge_data
```




# left_join sample data

We will now want to combine the sample data we have curated yesterday and the gene expression data. If you quickly check the number of samples in each of the datasets, you will realise that there isn't a one-to-one mapping between the samples. 

This means we need to combine two datasets using a common sample name. `left_join` can help us with this. 



```{r}
ge_sample_data = data.frame(
  sample = colnames(clean_ge_data)[-1],
  ge_data_available = "yes"
)

joined_sample_data = left_join(session1_data, ge_sample_data, by = "sample")

joined_sample_data
```


# DT

We can use the datatable function from the DT package to quickly browse through which samples in the sample data did not have a matching gene expression data. 

```{r}
joined_sample_data %>% 
  DT::datatable()
```

So we see indeed, there are sample mismatching between the sample and the gene expression data. How should we combine these data in this case? Let us learn about the pivot function first before returning to this problem.

# `tidyr::pivot_longer` the gene expression data

The pivot_longer function takes a wide data into a long data. 


```{r}
ge_data_long = clean_ge_data %>% 
  tidyr::pivot_longer(
    cols = -GENE_SYMBOL,
    names_to = "sample", 
    values_to = "gene_expression")

ge_data_long
```


We will now left_join this long data with the sample data and filter out the NA's in the data. 

```{r}
long_sample_ge_data = session1_data %>% 
  left_join(ge_data_long, by = "sample") %>% 
  dplyr::filter(!is.na(GENE_SYMBOL)) %>% 
  janitor::clean_names()


long_sample_ge_data
```


This will be the data we use for visualisation. 


# `ggplot2` visualisation

There are many plotting systems and packages out there, so why should we use this `ggplot2` system?

The `gg` in `ggplot2` stands for "grammar of graphics". That means in order to produce a ggplot, a very strict set of coding structure must be followed. These restrictions means that you can always look at a plot and know exactly which characteristic of the plot comes from which part of the data. This is extremely important for the purpose of reproducibility. 

The `ggplot2` plotting system is based on a layered structure, which means the final plot can always be decompose into several layers. We will illustrate what this means now step-by-step. 


Let's say we want to draw a scatter plot of the strains and the gene expression. We will first begin with a data and pipe that into the `ggplot()` function. This will give us a blank canvas for plotting. 

```{r}
long_sample_ge_data

long_sample_ge_data %>% 
  ggplot()
```


Now is a good time to think about what are the components of a scatter plot? 

+ x-coordinates of points
+ y-coordinates of points
+ Actually placement of points

The first two components are referred to as "mapping" in ggplot. Because the x-coordinates should be stored as a column in the `data.frame`, so we will "map" this column to be a characteristic on our ggplot. Similary, the y-coordinates should also be a mapping. This is why we write our code in the following manner. Note, we are using the `aes()` function to wrap everything. 


```{r}
long_sample_ge_data %>% 
  ggplot(mapping = aes(x = strain, y = gene_expression))
```


Now what we have is still a blank canvas, but notice how the x and y axes are now labelled with the variables/columns in the `data.frame`. So what are we missing for a scatter plot? 

The points!

In `ggplot2`, the final plot (whether it is a scatter plot or a boxplot or a mix of the two) is always a combination of layers. We now have a layer of blank canvas, we will want to draw on this canvas using `geom_point()` which places the actual points on the canvas based on the mapping we have already specified. 

```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point()
```


This is your first ggplot! Let's give it a title!

```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point() +
  labs(title = "My first ggplot!")
```



We see that the scale of data points can be very different. This is due to some genes always tend to have a higher expression than others. So it will be a good idea to make a plot for each of the gene instead. This means that we need to make this plot according to the labelling in the `gene_symbol` column in our `data.frame`. 


```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point() +
  facet_wrap(~gene_symbol)
```


This plot shows that "Aldh3a1" is th main culprit that has a very different scale than all other five genes. One way to deal with this scaling is to use the logarithm scale. `ggplot2` has a very convenient way to doing this. 



```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point() +
  facet_wrap(~gene_symbol) +
  scale_y_log10()
```


Now that we have the scatter plot of the genes on a good scale, and we can see some interesting features from these plots. For example, the "Aldh3a1" gene seems to show off some differences between the two strains, and the "Bbs2" gene seems to have a different variance between the two strains. 

So, how can we improve on this plot further?

We can layer other plots onto this! We will now add a boxplot to each of the plot.

```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point() +
  geom_boxplot() +
  facet_wrap(~gene_symbol) +
  scale_y_log10()
```

Now it is a good time to stop and think about what we did. We started off with a `data.frame` and a blank canvas with the aim to make a scatter plot. We added aesthetic mappings onto our ggplot and evaluated the quality of our plot as we go along. Every time we identify some deficiency in our plot, we simply add more layers to the plot. This almost detective-work is what makes `ggplot2` is so popular, because it is very flexible in handling new ideas and plotting aesthetics. But at the same time, every aesthetic of this plot can be traced back to a particular column in the `data.frame`. 


There are so many functions and tricks that we can't really go through in details. Here is a very helpful [cheatsheet](https://rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf). And in general, the best way is to Google the plot that you want and copy the code that someone else already made. 

```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression)) + 
  geom_point() +
  geom_boxplot() +
  facet_wrap(~gene_symbol) +
  scale_y_log10(labels = scales::comma)
```


Have a play with the following code. Try deleting components of the code to understand which aspect of the plot it was controlling


```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = strain, 
             y = gene_expression, 
             colour = strain)) + 
  geom_point() +
  geom_boxplot() +
  facet_wrap(~gene_symbol, scales = "free_y") +
  scale_y_log10(labels = scales::comma) +
  labs(x = "Strain", 
       y = "Gene Expression", 
       title = "Boxplot of genes across strains")
```


## Histogram
```{r}
long_sample_ge_data %>% 
  ggplot(aes(x = gene_expression)) + 
  geom_histogram()


long_sample_ge_data %>% 
  ggplot(aes(x = gene_expression)) + 
  geom_histogram() +
  facet_wrap(~gene_symbol) +
  scale_x_log10(labels = scales::comma)


long_sample_ge_data %>% 
  ggplot(aes(x = gene_expression)) + 
  geom_histogram() +
  geom_density() +
  facet_wrap(~gene_symbol) +
  scale_x_log10(labels = scales::comma)

long_sample_ge_data %>% 
  ggplot(aes(x = gene_expression, y = ..density..)) + 
  geom_histogram() +
  geom_density() +
  facet_wrap(~gene_symbol) +
  scale_x_log10(labels = scales::comma)
```


# `tidyr::pivot_wider` the gene expression data

The pivor wider function undoes the pivot longer function. Why would we want to use such functions? It is because that we must think about how each variable maps to each plot. In the long format data, we considered each gene as observations. But now, if we want to plot two genes against each other, then we need to map them to the two axes. 

```{r}
wide_sample_ge_data = long_sample_ge_data %>% 
  tidyr::pivot_wider(names_from = "gene_symbol",
                     values_from = "gene_expression")
```

## Visualisation
```{r}
wide_sample_ge_data %>% 
  ggplot(aes(x = Ahrr,
             y = Cxcr7,
             colour = strain)) +
  geom_point() +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
geom_smooth(method = "lm")
```


```{r}
write_csv(long_sample_ge_data, path = "data/long_sample_ge_data.csv")
write_csv(wide_sample_ge_data, path = "data/wide_sample_ge_data.csv")
```




# Session Info
```{r}
sessionInfo()
```

