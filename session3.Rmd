---
title: "session3"
author: "Kevin Wang and Garth Tarr"
date: "05/11/2019"
output: html_document
---



# Learning outcomes of this session

+ More plotting with `ggplot2`
+ `for` loops and `purrr::map` functions
+ Modelling with `broom`



# Loading packages

```{r}
library(tidyverse)
library(skimr)
```


# Loading cleaned sample data

```{r}
session3_data = read_csv(file = "data/session3_data.csv") %>% 
  dplyr::select(-time, -dose)

clean_data = session3_data %>% 
  dplyr::mutate_if(is.numeric, .funs = log)

hw_data = clean_data %>% 
  dplyr::filter(strain == "HW")

le_data = clean_data %>% 
  dplyr::filter(strain == "LE")
```

# Correlation analysis

```{r}
clean_data %>% 
  ggplot(aes(x = Ahrr,
             y = Cxcr7,
             colour = strain)) +
  geom_point() +
  geom_smooth(method = "lm")


lm(Ahrr ~ Cxcr7, data = clean_data)
lm(Ahrr ~ Cxcr7, data = hw_data)
lm(Ahrr ~ Cxcr7, data = le_data)

lm_Ahrr_Cxcr7 = function(this_data){
  lm(Ahrr ~ Cxcr7, data = this_data)
}

list_data = list(
  clean_data = clean_data, 
  hw_data = hw_data,
  le_data = le_data)

purrr::map(.x = list_data, 
           .f = lm_Ahrr_Cxcr7)

purrr::map(.x = list_data, 
           .f = lm_Ahrr_Cxcr7) %>% 
  purrr::map(.f = broom::tidy)
```




```{r}
Cxcr7_long = clean_data %>%
  tidyr::pivot_longer(
    cols = -c("strain", "Cxcr7", "sample"),
    names_to = "gene_symbols",
    values_to = "gene_expression")

Cxcr7_long

Cxcr7_nest = Cxcr7_long %>% 
  group_by(strain, gene_symbols) %>% 
  tidyr::nest()

Cxcr7_nest$data[1:2]

lm_Cxcr7_ge = function(this_data){
  lm(Cxcr7 ~ gene_expression, data = this_data)
}

Cxcr7_model = Cxcr7_nest %>% 
  dplyr::mutate(lm_obj = purrr::map(.x = data, 
                                    .f = lm_Cxcr7_ge),
                lm_tidy = purrr::map(.x = lm_obj,
                                     .f = broom::tidy))



Cxcr7_model_long = Cxcr7_model %>% 
  dplyr::select(-data, -lm_obj) %>% 
  tidyr::unnest(lm_tidy) %>% 
  dplyr::select(strain, gene_symbols, term, estimate) %>% 
  dplyr::filter(term == "gene_expression")


Cxcr7_model_long


Cxcr7_model_wide = Cxcr7_model_long %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(names_from = "strain",
                     values_from = "estimate")


Cxcr7_model_wide %>% 
  ggplot(aes(x = HW, y = LE)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, colour = "red")

Cxcr7_model_wide %>% 
  ggplot(aes(x = HW, y = LE,
             label = gene_symbols)) +
  geom_text() +
  geom_abline(slope = 1, intercept = 0, colour = "red")
```

# Session Info
```{r}
sessionInfo()
```

